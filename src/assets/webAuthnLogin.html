<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>sign up</title>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      align-items: start;
      padding-top: 100px;
      background-color: #f5f5f5;
    }

    .form-signin {
      max-width: 330px;
      padding: 15px;
    }

    .form-signin .form-floating:focus-within {
      z-index: 2;
    }

    .form-signin input[type="username"] {
      margin-bottom: -1px;
      border-bottom-right-radius: 0;
      border-bottom-left-radius: 0;
    }

    .form-signin input[type="password"] {
      margin-bottom: -1px;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
  </style>
  <script>

    var baseurl = "http://localhost:1001/oauth/";
    var rpid = "localhost";

    async function get() {
      try {
        // 功能检测和 UVPA 可用性
        // 如果满足以下条件之一，用户必须使用密码登录：
        // WebAuthn 不可用。
        // UVPA 不可用。
        // 检测不到该 UVPA 的凭据 ID。  检测不到？？？
        if (window.PublicKeyCredential) {
          await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
            .then(uvpaa => {
              if (uvpaa) {
              } else {
                alert("请使用支持WebAuthn的浏览器");
                return;
              }
            });
        }
        await get_1();
      } catch (e) {

        alert(e)
      }
    }
    async function get_1() {
      var challenge = stringToArrayBuffer(base64UrlEncode("12345678901234567890"));
      var username = $("#username").val();

      var allowCredentials = [];
      var publicKeyCredentialRequestOptions;
      await $.ajax({
        url: baseurl + "client/webauthn-auth-challenge",
        type: "POST",
        dataType: "json",
        async: false,
        data: {
          "username": username
        },
        success: function (data) {
          console.log(data);
          if (data.publicKeyCredentialRequestOptions) {
            publicKeyCredentialRequestOptions = JSON.parse(base64UrlDecode(data.publicKeyCredentialRequestOptions));
          }
        },
        error: function (error) {
          // 处理错误
          alert("同步请求错误", error);
        }
      });


      challenge = base64UrlToArrayBuffer(publicKeyCredentialRequestOptions.challenge);
      var credentialRequestOptions = {
        publicKey: {
          allowCredentials,
          challenge,
          //extensions: undefined,
          rpId: publicKeyCredentialRequestOptions.rpId,
          timeout: 60000,
          userVerification: $("#userVerification").val()
        },
        // signal: new AbortController().signal,
        mediation: $("#conditional").val() == "undefined" ? undefined : $("#conditional").val()
      };

      console.log(credentialRequestOptions);

      // Create credential using WebAuthn API
      const credential = await navigator.credentials.get(credentialRequestOptions);

      console.log(credential);

      $("#authenticationResponseJSON").val(base64UrlEncode(JSON.stringify(credential.toJSON())));

      $("#webauthn").click();

      alert("login success");
    }

    function stringToArrayBuffer(str) {
      // const encoder = new TextEncoder();
      // return encoder.encode(str).buffer;

      return base64UrlToArrayBuffer(str);
    }

    function arrayBufferToString(buffer) {
      // const decoder = new TextDecoder();
      // decoder.decode(new Uint8Array(buffer));

      return arrayBufferToBase64Url(buffer);
    }

    function base64UrlToArrayBuffer(base64Url) {
      return base64ToArrayBuffer(base64Urltobase64(base64Url));
    }

    function arrayBufferToBase64Url(buffer) {
      var base64 = arrayBufferToBase64(buffer);
      return base64tobase64Url(base64);
    }


    function base64Encode(str) {
      // 首先进行Base64编码
      const base64 = btoa(str);
      // 替换Base64URL不安全的字符
      return base64;
    }

    function base64Decode(base64) {
      // 首先进行Base64解码
      const str = atob(base64);
      // 替换Base64URL不安全的字符
      return str;
    }

    function base64UrlEncode(str) {
      // 首先进行Base64编码
      const base64 = base64Encode(str);
      // 替换Base64URL不安全的字符
      return base64tobase64Url(base64);
    }

    function base64UrlDecode(base64Url) {
      // Step 1: 将 base64url 字符替换为 base64 字符
      let base64 = base64Urltobase64(base64Url);
      // 首先进行Base64解码
      const str = atob(base64);
      // 替换Base64URL不安全的字符
      return str;
    }

    function base64tobase64Url(base64) {
      // 替换Base64URL不安全的字符
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function base64Urltobase64(base64Url) {
      // Step 1: 将 base64url 字符替换为 base64 字符
      let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');

      // Step 2:  添加缺失的 '=' 填充
      while (base64.length % 4) {
        base64 += '=';
      }
      return base64;
    }

    function base64ToArrayBuffer(base64) {
      const binaryString = base64Decode(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    }

    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return base64Encode(binary);
    }


  </script>
</head>

<body>
  <div class="container">
    <form class="form-signin w-100 m-auto" method="post" action="register.html">
      <h1 class="h3 mb-3 fw-normal">Please sign in</h1>
      <div class="form-floating">
        <input type="text" id="username" name="username" class="form-control" autocomplete="username webauthn"
          placeholder="Username" />
        <label for="username">Username</label>
      </div>

      <div class="form-floating">
        userVerification
        <select id="userVerification" name="userVerification" class="form-control">
          <option value="undefined">undefined</option>
          <option value="discouraged">discouraged</option>
          <option value="preferred" selected>preferred</option>
          <option value="required">required</option>
        </select>
      </div>
      <div class="form-floating">
        conditional
        <select id="conditional" name="conditional" class="form-control">
          <option value="undefined">undefined</option>
          <option value="conditional" selected>conditional</option>
          <option value="optional">optional</option>
        </select>
      </div>
      <input name="_csrf" type="hidden" value="a9b4b5d6-f63e-4875-8f6e-390202b050f4" />
      <input name="authenticationResponseJSON" id="authenticationResponseJSON" type="hidden" />
      <div>
        <button type="submit" class="w-100 btn btn-lg btn-primary btn-block">Sign in</button>
        <button type="submit" id="webauthn" formaction="https://auth.cnss.eu.org/oauth/client/webauthn-auth" style="display: none"></button>
      </div>
      <div>
        <button type="button" class="w-100 btn btn-lg btn-primary btn-block" onclick="get()">test</button>
      </div>
    </form>
  </div>
  <script>

    // get();


  </script>
</body>

</html>