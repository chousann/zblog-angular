<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>sign up</title>
  <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      align-items: start;
      padding-top: 100px;
      background-color: #f5f5f5;
    }

    .form-signin {
      max-width: 330px;
      padding: 15px;
    }

    .form-signin .form-floating:focus-within {
      z-index: 2;
    }

    .form-signin input[type="username"] {
      margin-bottom: -1px;
      border-bottom-right-radius: 0;
      border-bottom-left-radius: 0;
    }

    .form-signin input[type="password"] {
      margin-bottom: -1px;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
  </style>
  <script>
    //获取验证码
    async function create() {

      var username = $("#username").val();
      var challenge = stringToArrayBuffer("12345678901234567890");

      var credentialCreationOptions = {
        publicKey: {
          attestation: 'none',
          authenticatorSelection: {
            authenticatorAttachment: undefined,
            residentKey: undefined,
            userVerification: 'preferred'
          },
          challenge,
          excludeCredentials: [],
          extensions: undefined,
          pubKeyCredParams: [
            { alg: -7, type: 'public-key' },  // ES256
            { alg: -257, type: 'public-key' } // RS256
          ],
          rp: {
            name: 'WebAuthn Demo',
            id: 'chousann.github.io'
          },
          timeout: 60000,
          user: {
            id: stringToArrayBuffer(base64Encode(username)),
            name: username,
            displayName: username
          }
        },
        signal: undefined
      };

      console.log(credentialCreationOptions);
      // Create credential using WebAuthn API
      const credential = await navigator.credentials.create(credentialCreationOptions);

      localStorage.setItem(username, credential.id);
      console.log(credential);
      
      alert("register success");
    }

    async function get() {
      var challenge = stringToArrayBuffer("12345678901234567890");
      var username = $("#username").val();

      var allowCredentials = [];
      if (!username) {
        allowCredentials = [];
      } else {
        allowCredentials = [{
          id: stringToArrayBuffer(localStorage.getItem(username)), // Assuming username is used as ID for simplicity
          type: 'public-key'
        }];
      };

      var credentialRequestOptions = {
        publicKey: {
          allowCredentials,
          challenge,
          extensions: undefined,
          rpId: 'chousann.github.io',
          timeout: 60000,
          userVerification: undefined
        },
        signal: undefined,
        mediation: undefined
      };

      console.log(credentialRequestOptions);

      // Create credential using WebAuthn API
      const credential = await navigator.credentials.get(credentialRequestOptions);

      console.log(credential);
      
      alert("login success");
    }

    function stringToArrayBuffer(str) {
      // const encoder = new TextEncoder();
      // return encoder.encode(str).buffer;

      return base64UrlToArrayBuffer(str);
    }

    function arrayBufferToString(buffer) {
      // const decoder = new TextDecoder();
      // decoder.decode(new Uint8Array(buffer));

      return arrayBufferToBase64Url(buffer);
    }

    function base64UrlToArrayBuffer(base64Url) {
      // Handle null or undefined input
      if (!base64Url) {
        return new ArrayBuffer(0);
      }

      // Convert base64url to base64
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/').replace(/=/g, '');

      // Add padding if needed
      const padLength = (4 - (base64.length % 4)) % 4;
      const paddedBase64 = base64 + '='.repeat(padLength);

      try {
        const binaryString = atob(paddedBase64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
      } catch (e) {
        console.error('Failed to decode base64 string:', base64Url);
        return new ArrayBuffer(0);
      }
    }

    function arrayBufferToBase64Url(buffer) {
      if (!buffer) {
        return '';
      }

      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      const base64 = btoa(binary);
      // Convert base64 to base64url
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }
    
    function base64Encode(str) {
      // 首先进行Base64编码
      const base64 = btoa(unescape(encodeURIComponent(str)));
      // 替换Base64URL不安全的字符
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
  </script>
</head>

<body>
  <div class="container">
    <form class="form-signin w-100 m-auto" method="post" action="registerByMail">
      <h1 class="h3 mb-3 fw-normal">Please sign in</h1>
      <div class="form-floating">
        <input type="text" id="username" name="username" class="form-control" required autofocus>
        <label for="username">Username</label>
      </div>

      <input name="_csrf" type="hidden" value="a9b4b5d6-f63e-4875-8f6e-390202b050f4" />
      <div>
        <button type="button" class="w-100 btn btn-lg btn-primary btn-block" onclick="get()">Sign in</button>
      </div>
      <div>
        <button type="button" class="w-100 btn btn-lg btn-primary btn-block" onclick="create()">Sign up</button>
      </div>
    </form>
  </div>
</body>

</html>